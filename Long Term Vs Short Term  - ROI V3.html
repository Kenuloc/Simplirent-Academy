<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Advanced Rental ROI Calculator</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 2rem; max-width: 1200px; margin: auto; }
    input, select { width: 100%; padding: 0.5rem; margin: 0.5rem 0; }
    .result { margin-top: 1rem; font-weight: bold; }
    .warning { color: red; font-weight: bold; margin-top: 1rem; }
    .info { margin-top: 20px; padding: 1rem; background-color: #f5f5f5; border-radius: 5px; }
    .container { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
    .calculator, .country-info { padding: 1rem; }
    h2 { margin-top: 0; }
    .tabs { display: flex; margin-bottom: 1rem; }
    .tab { padding: 0.5rem 1rem; cursor: pointer; border: 1px solid #ddd; }
    .tab.active { background-color: #4CAF50; color: white; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .chart-container { margin-top: 2rem; height: 300px; }
    .comparison { grid-column: span 2; margin-top: 2rem; }
    .monthly-income { margin-top: 1rem; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #f2f2f2; }
  </style>
</head>
<body>
  <h1>Advanced Rental ROI Calculator</h1>
  
  <div class="container">
    <div class="calculator">
      <h2>Rental Calculator</h2>
      
      <label for="country">Country:</label>
      <select id="country" onchange="updateCountryData()">
        <option value="South Africa">South Africa</option>
        <option value="United States">United States</option>
        <option value="United Kingdom">United Kingdom</option>
        <option value="Australia">Australia</option>
        <option value="Canada">Canada</option>
        <option value="India">India</option>
        <option value="Japan">Japan</option>
        <option value="Germany">Germany</option>
        <option value="France">France</option>
        <option value="Brazil">Brazil</option>
      </select>

      <label for="city">City/Area:</label>
      <input type="text" id="city" list="cityList" value="Cape Town">
      <datalist id="cityList"></datalist>

      <label for="currency">Currency:</label>
      <input type="text" id="currency" value="ZAR" readonly>

      <label for="bedrooms">Number of Bedrooms:</label>
      <input type="number" id="bedrooms" value="2">

      <div class="tabs">
        <div class="tab active" onclick="switchTab('ltr')">LTR</div>
        <div class="tab" onclick="switchTab('str')">STR</div>
      </div>

      <div id="ltr-tab" class="tab-content active">
        <label for="ltr-rate">Monthly Rent:</label>
        <input type="number" id="ltr-rate" value="15000">

        <label for="ltr-managementFee">Management Fee (%):</label>
        <select id="ltr-managementFee">
          <!-- Options generated by JavaScript from 1% to 30% -->
        </select>
      </div>

      <div id="str-tab" class="tab-content">
        <label for="str-rate">Nightly Rate:</label>
        <input type="number" id="str-rate" value="1000">

        <label for="occupancy">Occupancy Rate (%):</label>
        <input type="number" id="occupancy" value="67">

        <label for="str-managementFee">Management Fee (%):</label>
        <select id="str-managementFee">
          <!-- Options generated by JavaScript from 1% to 30% -->
        </select>
      </div>

      <label for="maintenance">Monthly Maintenance:</label>
      <input type="number" id="maintenance" value="1000">

      <label for="mortgage">Mortgage + Taxes (Monthly):</label>
      <input type="number" id="mortgage" value="25000">

      <label for="investment">Total Investment:</label>
      <input type="number" id="investment" value="670000">

      <button onclick="calculateROI()">Calculate</button>

      <div class="result" id="results"></div>
      <div class="warning" id="priceWarning"></div>
    </div>

    <div class="country-info">
      <h2>Country Information</h2>
      <label for="country-select">Select a Country for More Info:</label>
      <select id="country-select">
        <option value="">-- Select Country --</option>
      </select>
      <div id="country-info" class="info"></div>
    </div>
  </div>

  <div class="comparison">
    <h2>Rental Strategy Comparison</h2>
    
    <div class="tabs">
      <div class="tab active" onclick="switchComparisonTab('income')">Monthly Income</div>
      <div class="tab" onclick="switchComparisonTab('returns')">Returns Comparison</div>
    </div>
    
    <div id="income-tab" class="tab-content active">
      <h3>12-Month Income Projection</h3>
      <div class="monthly-income">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div>
            <h4>Long-Term Rental (LTR)</h4>
            <table id="ltr-income-table">
              <thead>
                <tr>
                  <th>Month</th>
                  <th>Income</th>
                  <th>Expenses</th>
                  <th>Profit</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div>
            <h4>Short-Term Rental (STR)</h4>
            <table id="str-income-table">
              <thead>
                <tr>
                  <th>Month</th>
                  <th>Income</th>
                  <th>Expenses</th>
                  <th>Profit</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    
    <div id="returns-tab" class="tab-content">
      <h3>Returns Comparison</h3>
      <div class="chart-container">
        <canvas id="returnsChart"></canvas>
      </div>
    </div>
  </div>

  <script>
    // Country data for the calculator
    const countryData = {
      "United States": {"currency": "USD", "cities": ["New York", "Los Angeles", "Chicago", "Miami"]},
      "South Africa": {"currency": "ZAR", "cities": ["Cape Town", "Johannesburg", "Durban", "Pretoria"]},
      "United Kingdom": {"currency": "GBP", "cities": ["London", "Manchester", "Birmingham", "Glasgow"]},
      "Australia": {"currency": "AUD", "cities": ["Sydney", "Melbourne", "Brisbane", "Perth"]},
      "Canada": {"currency": "CAD", "cities": ["Toronto", "Vancouver", "Montreal", "Calgary"]},
      "India": {"currency": "INR", "cities": ["Mumbai", "Delhi", "Bangalore", "Hyderabad"]},
      "Japan": {"currency": "JPY", "cities": ["Tokyo", "Osaka", "Kyoto", "Fukuoka"]},
      "Germany": {"currency": "EUR", "cities": ["Berlin", "Munich", "Frankfurt", "Hamburg"]},
      "France": {"currency": "EUR", "cities": ["Paris", "Lyon", "Marseille", "Toulouse"]},
      "Brazil": {"currency": "BRL", "cities": ["Sao Paulo", "Rio de Janeiro", "Brasilia", "Salvador"]}
    };

    // Chart instance
    let returnsChart = null;

    // Initialize management fee dropdowns
    function initializeManagementFees() {
      const ltrSelect = document.getElementById('ltr-managementFee');
      const strSelect = document.getElementById('str-managementFee');
      
      // Clear existing options
      ltrSelect.innerHTML = '';
      strSelect.innerHTML = '';
      
      // Add options from 1% to 30%
      for (let i = 1; i <= 30; i++) {
        const option1 = document.createElement('option');
        option1.value = i;
        option1.textContent = `${i}%`;
        ltrSelect.appendChild(option1);
        
        const option2 = document.createElement('option');
        option2.value = i;
        option2.textContent = `${i}%`;
        strSelect.appendChild(option2);
      }
      
      // Set default values
      ltrSelect.value = '10'; // Default 10% for LTR
      strSelect.value = '20'; // Default 20% for STR
    }

    // Tab switching functions
    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      
      document.querySelector(`.tab[onclick="switchTab('${tab}')"]`).classList.add('active');
      document.getElementById(`${tab}-tab`).classList.add('active');
    }

    function switchComparisonTab(tab) {
      document.querySelectorAll('.comparison .tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.comparison .tab-content').forEach(c => c.classList.remove('active'));
      
      document.querySelector(`.comparison .tab[onclick="switchComparisonTab('${tab}')"]`).classList.add('active');
      document.getElementById(`${tab}-tab`).classList.add('active');
      
      if (tab === 'returns' && returnsChart) {
        returnsChart.update();
      }
    }

    // Update calculator country data
    function updateCountryData() {
      const country = document.getElementById('country').value;
      const data = countryData[country];
      
      // Update currency
      document.getElementById('currency').value = data.currency;
      
      // Update city datalist
      const cityList = document.getElementById('cityList');
      cityList.innerHTML = '';
      data.cities.forEach(city => {
        const option = document.createElement('option');
        option.value = city;
        cityList.appendChild(option);
      });
      
      // Reset city input if it's not in the new country's cities
      const currentCity = document.getElementById('city').value;
      if (!data.cities.includes(currentCity)) {
        document.getElementById('city').value = data.cities[0];
      }
      
      // Also update the country info selector to match
      document.getElementById('country-select').value = country;
      if (country) {
        fetchCountryInfo(country);
      }
    }

    // Calculate monthly projections
    function calculateMonthlyProjections(revenue, expenses, months = 12) {
      const projections = [];
      for (let i = 1; i <= months; i++) {
        projections.push({
          month: i,
          income: revenue,
          expenses: expenses,
          profit: revenue - expenses
        });
      }
      return projections;
    }

    // Update income tables
    function updateIncomeTables(ltrProjections, strProjections) {
      const ltrTable = document.querySelector('#ltr-income-table tbody');
      const strTable = document.querySelector('#str-income-table tbody');
      
      ltrTable.innerHTML = '';
      strTable.innerHTML = '';
      
      const currency = document.getElementById('currency').value;
      
      ltrProjections.forEach(proj => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${proj.month}</td>
          <td>${currency} ${proj.income.toFixed(2)}</td>
          <td>${currency} ${proj.expenses.toFixed(2)}</td>
          <td>${currency} ${proj.profit.toFixed(2)}</td>
        `;
        ltrTable.appendChild(row);
      });
      
      strProjections.forEach(proj => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${proj.month}</td>
          <td>${currency} ${proj.income.toFixed(2)}</td>
          <td>${currency} ${proj.expenses.toFixed(2)}</td>
          <td>${currency} ${proj.profit.toFixed(2)}</td>
        `;
        strTable.appendChild(row);
      });
    }

    // Update comparison chart
    function updateComparisonChart(ltrData, strData) {
      const ctx = document.getElementById('returnsChart').getContext('2d');
      const currency = document.getElementById('currency').value;
      
      if (returnsChart) {
        returnsChart.destroy();
      }
      
      returnsChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['LTR', 'STR'],
          datasets: [
            {
              label: `Monthly Revenue (${currency})`,
              data: [ltrData.revenue, strData.revenue],
              backgroundColor: 'rgba(54, 162, 235, 0.5)',
              borderColor: 'rgba(54, 162, 235, 1)',
              borderWidth: 1
            },
            {
              label: `Monthly Expenses (${currency})`,
              data: [ltrData.expenses, strData.expenses],
              backgroundColor: 'rgba(255, 99, 132, 0.5)',
              borderColor: 'rgba(255, 99, 132, 1)',
              borderWidth: 1
            },
            {
              label: `Monthly Profit (${currency})`,
              data: [ltrData.cashFlow, strData.cashFlow],
              backgroundColor: 'rgba(75, 192, 192, 0.5)',
              borderColor: 'rgba(75, 192, 192, 1)',
              borderWidth: 1
            },
            {
              label: `Annual ROI (%)`,
              data: [ltrData.roi, strData.roi],
              backgroundColor: 'rgba(153, 102, 255, 0.5)',
              borderColor: 'rgba(153, 102, 255, 1)',
              borderWidth: 1,
              yAxisID: 'y1'
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Amount'
              }
            },
            y1: {
              position: 'right',
              beginAtZero: true,
              title: {
                display: true,
                text: 'ROI %'
              },
              grid: {
                drawOnChartArea: false
              }
            }
          }
        }
      });
    }

    // ROI Calculation function
    function calculateROI() {
      const bedrooms = parseInt(document.getElementById('bedrooms').value);
      const maintenance = parseFloat(document.getElementById('maintenance').value);
      const mortgage = parseFloat(document.getElementById('mortgage').value);
      const investment = parseFloat(document.getElementById('investment').value);
      const currency = document.getElementById('currency').value;

      // Calculate LTR
      const ltrRate = parseFloat(document.getElementById('ltr-rate').value);
      const ltrManagementFee = parseFloat(document.getElementById('ltr-managementFee').value) / 100;
      
      const ltrRevenue = ltrRate;
      const ltrManagementCost = ltrRevenue * ltrManagementFee;
      const ltrExpenses = mortgage + ltrManagementCost + maintenance;
      const ltrCashFlow = ltrRevenue - ltrExpenses;
      const ltrAnnualCashFlow = ltrCashFlow * 12;
      const ltrRoi = (ltrAnnualCashFlow / investment) * 100;
      
      const ltrProjections = calculateMonthlyProjections(ltrRevenue, ltrExpenses);

      // Calculate STR
      const strRate = parseFloat(document.getElementById('str-rate').value);
      const occupancy = parseFloat(document.getElementById('occupancy').value) / 100;
      const strManagementFee = parseFloat(document.getElementById('str-managementFee').value) / 100;
      
      const strRevenue = strRate * 30 * occupancy;
      const strManagementCost = strRevenue * strManagementFee;
      const strExpenses = mortgage + strManagementCost + maintenance;
      const strCashFlow = strRevenue - strExpenses;
      const strAnnualCashFlow = strCashFlow * 12;
      const strRoi = (strAnnualCashFlow / investment) * 100;
      
      const strProjections = calculateMonthlyProjections(strRevenue, strExpenses);

      // Update results display
      document.getElementById('results').innerHTML = `
        <p><strong>Current Mode:</strong> ${document.querySelector('.tab.active').textContent}</p>
        <p><strong>Monthly Revenue:</strong> ${currency} ${document.querySelector('.tab.active').textContent === 'LTR' ? ltrRevenue.toFixed(2) : strRevenue.toFixed(2)}</p>
        <p><strong>Monthly Expenses:</strong> ${currency} ${document.querySelector('.tab.active').textContent === 'LTR' ? ltrExpenses.toFixed(2) : strExpenses.toFixed(2)}</p>
        <p><strong>Monthly Cash Flow:</strong> ${currency} ${document.querySelector('.tab.active').textContent === 'LTR' ? ltrCashFlow.toFixed(2) : strCashFlow.toFixed(2)}</p>
        <p><strong>Annual ROI:</strong> ${document.querySelector('.tab.active').textContent === 'LTR' ? ltrRoi.toFixed(2) : strRoi.toFixed(2)}%</p>
      `;

      // Price per bedroom warning logic
      const pricePerBedroom = investment / bedrooms;
      const warningThreshold = countryData[document.getElementById('country').value].currency === 'ZAR' ? 500000 : 30000;
      if (pricePerBedroom < warningThreshold) {
        document.getElementById('priceWarning').innerText =
          `⚠️ Price per bedroom is below ${currency} ${warningThreshold.toLocaleString()} (${pricePerBedroom.toLocaleString()}). This may indicate a high-risk or unrealistic deal.`;
      } else {
        document.getElementById('priceWarning').innerText = '';
      }

      // Update comparison data
      updateIncomeTables(ltrProjections, strProjections);
      updateComparisonChart(
        {
          revenue: ltrRevenue,
          expenses: ltrExpenses,
          cashFlow: ltrCashFlow,
          roi: ltrRoi
        },
        {
          revenue: strRevenue,
          expenses: strExpenses,
          cashFlow: strCashFlow,
          roi: strRoi
        }
      );
    }

    // Country Info API functions
    async function fetchCountries() {
      try {
        const response = await fetch('https://restcountries.com/v3.1/all');
        const countries = await response.json();
        const countrySelect = document.getElementById('country-select');
        
        // Sort countries alphabetically
        countries.sort((a, b) => a.name.common.localeCompare(b.name.common));
        
        countries.forEach(country => {
          const option = document.createElement('option');
          option.value = country.name.common;
          option.textContent = country.name.common;
          countrySelect.appendChild(option);
        });
      } catch (error) {
        console.error("Error fetching countries:", error);
        document.getElementById('country-info').innerHTML = 
          "<p>Could not load country data. Please check your internet connection.</p>";
      }
    }

    async function fetchCountryInfo(countryName) {
      try {
        const response = await fetch(`https://restcountries.com/v3.1/name/${countryName}`);
        if (!response.ok) throw new Error("Country not found");
        
        const countryData = await response.json();
        const countryInfo = countryData[0];
        
        const infoDiv = document.getElementById('country-info');
        
        // Get currency info (handle cases where currencies might be missing)
        let currencyInfo = 'N/A';
        if (countryInfo.currencies) {
          currencyInfo = Object.values(countryInfo.currencies)
            .map(currency => `${currency.name} (${currency.symbol || 'No symbol'})`)
            .join(', ');
        }
        
        // Show country info
        infoDiv.innerHTML = `
          <h3>${countryInfo.name.common} ${countryInfo.flag || ''}</h3>
          <p><strong>Official Name:</strong> ${countryInfo.name.official}</p>
          <p><strong>Capital:</strong> ${countryInfo.capital ? countryInfo.capital.join(', ') : 'N/A'}</p>
          <p><strong>Region:</strong> ${countryInfo.region} ${countryInfo.subregion ? `(${countryInfo.subregion})` : ''}</p>
          <p><strong>Population:</strong> ${countryInfo.population.toLocaleString()}</p>
          <p><strong>Currency:</strong> ${currencyInfo}</p>
          <p><strong>Languages:</strong> ${countryInfo.languages ? Object.values(countryInfo.languages).join(', ') : 'N/A'}</p>
        `;
      } catch (error) {
        console.error("Error fetching country info:", error);
        document.getElementById('country-info').innerHTML = 
          "<p>Could not load information for this country. Please try another one.</p>";
      }
    }

    // Initialize the application
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize management fee dropdowns
      initializeManagementFees();
      
      // Initialize calculator
      updateCountryData();
      
      // Initialize country info
      fetchCountries();
      
      // Event listener for country info selection
      document.getElementById('country-select').addEventListener('change', function() {
        const countryName = this.value;
        if (countryName) {
          fetchCountryInfo(countryName);
          // Also update the calculator's country if different
          if (document.getElementById('country').value !== countryName) {
            document.getElementById('country').value = countryName;
            updateCountryData();
          }
        }
      });
      
      // Sync calculator country with info panel
      document.getElementById('country').addEventListener('change', function() {
        const countryName = this.value;
        if (document.getElementById('country-select').value !== countryName) {
          document.getElementById('country-select').value = countryName;
          fetchCountryInfo(countryName);
        }
      });
      
      // Calculate on initial load
      calculateROI();
    });
  </script>
</body>
</html>